<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå§Ô∏è</text></svg>">
</head>

<body>
    <!-- Blue strip header -->
    <div class="header-container main-header">
        <div class="header-content">WEATHER</div>
        <form action="/" method="get" class="search-form">
            <div class="search-input-container">
                <input type="text" class="location-input-box" id="searchBar" name="location" placeholder="Enter location..." value="{{ location }}">
            </div>
            <button type="button" id="locationButton" class="location-button">
                üìç
            </button>
            <input type="submit" style="display: none;">
        </form>      
    </div>

    <!-- Invisible header for nav buttons -->
    <div class="header-container nav-header">
        <div class="nav-buttons">
            <div class="nav-button">Home</div>
            <a href="{{ url_for('map') }}" class="nav-button">Map</a>
        </div>
    </div>
    <!-- Name of city -->
    <div class="city-name-container" id="cityDisplay"></div>
    <!-- Day picker -->
    <div class="day-selector">
        <div class="day-box" id="day-1">
            <div class="day-name">Today</div>
            <div class="content">
                <div class="icon"></div>
                <div class="temps">
                    <div class="temp-max"></div>
                    <div class="temp-min"></div>
                </div>
            </div>
        </div>
        <div class="day-box" id="day-2">
            <div class="day-name"></div>
            <div class="content">
                <div class="icon"></div>
                <div class="temps">
                    <div class="temp-max"></div>
                    <div class="temp-min"></div>
                </div>
            </div>
        </div>
        <div class="day-box" id="day-3">
            <div class="day-name"></div>
            <div class="content">
                <div class="icon"></div>
                <div class="temps">
                    <div class="temp-max"></div>
                    <div class="temp-min"></div>
                </div>
            </div>
        </div>
        <div class="day-box" id="day-4">
            <div class="day-name"></div>
            <div class="content">
                <div class="icon"></div>
                <div class="temps">
                    <div class="temp-max"></div>
                    <div class="temp-min"></div>
                </div>
            </div>
        </div>
        <div class="day-box" id="day-5">
            <div class="day-name"></div>
            <div class="content">
                <div class="icon"></div>
                <div class="temps">
                    <div class="temp-max"></div>
                    <div class="temp-min"></div>
                </div>
            </div>
        </div>
        <div class="day-box" id="day-6">
            <div class="day-name"></div>
            <div class="content">
                <div class="icon"></div>
                <div class="temps">
                    <div class="temp-max"></div>
                    <div class="temp-min"></div>
                </div>
            </div>
        </div>
        <div class="day-box" id="day-7">
            <div class="day-name"></div>
            <div class="content">
                <div class="icon"></div>
                <div class="temps">
                    <div class="temp-max"></div>
                    <div class="temp-min"></div>
                </div>
            </div>
        </div>
        
    </div>
    <!-- Hourly view container -->
    <div class="hourly-view-container">
        <div class="weather-container" id="weatherContainer"></div>
    </div>

    <div>
        <!--Button to see charts-->
        <button id="chartButton">Show Chart</button>
    </div>

    <script>
        //script for chart button
        document.getElementById('chartButton').addEventListener('click', function () {
            window.location.href = '/chart'; // path to chart.html
        });

        let selectedDate = getTodayDate();
        let currentLatitude = null;
        let currentLongitude = null;
    
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }
    
        function getFutureDate(days) {
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + days);
            return futureDate.toISOString().split('T')[0];
        }
    
        function getDayName(daysAfterToday) {
            const date = new Date();
            date.setDate(date.getDate() + daysAfterToday);
            const options = { weekday: 'long' };
            const dayName = date.toLocaleDateString(undefined, options).slice(0, 3);
            const day = date.getDate();
            const daySuffix = getDaySuffix(day);
            return `${dayName} ${day}${daySuffix}`;
        }
    
        function getDaySuffix(day) {
            if (day >= 11 && day <= 13) {
                return 'th';
            }
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
    
        function updateDayBoxes() {
        const dayBoxes = document.querySelectorAll('.day-box');
        dayBoxes.forEach((box, index) => {
            const date = getFutureDate(index);
            box.setAttribute('data-date', date);
            box.textContent = index === 0 ? "Today" : getDayName(index);

            box.addEventListener('click', () => {
                dayBoxes.forEach(b => b.classList.remove('selected', 'unselected'));
                box.classList.add('selected');
                dayBoxes.forEach(b => {
                    if (!b.classList.contains('selected')) {
                        b.classList.add('unselected');
                    }
                });

                selectedDate = box.getAttribute('data-date');

                if (currentLatitude && currentLongitude) {
                    fetchWeatherDataHourly(currentLatitude, currentLongitude, selectedDate);
                }
            });
        });
        document.getElementById('')
    }
    
    async function fetchWeatherDataHourly(lat, lon, date) {
        try {
            const response = await fetch(`/getHourlyWeather?latitude=${lat}&longitude=${lon}&date=${date}`);
            const data = await response.json();
            const weatherContainer = document.getElementById('weatherContainer');
            weatherContainer.innerHTML = '';

            const currentDate = new Date();
            const selectedDate = new Date(date);
            const currentHour = currentDate.getHours();

            data.hourly.time.forEach((time, index) => {
                const boxHour = new Date(time).getHours();
                const boxDate = new Date(time).toISOString().split('T')[0];

                // Only create boxes for hours that are equal to or greater than the current hour if today is selected
                if (selectedDate.toISOString().split('T')[0] !== currentDate.toISOString().split('T')[0] || boxHour >= currentHour) {
                    const box = document.createElement('div');
                    box.className = 'box';

                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'time';
                    timeDiv.textContent = boxHour + ':00';
                    box.appendChild(timeDiv);

                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'icon';
                    // Change icon to moon between 9 PM and 5 AM
                    if (boxHour >= 21 || boxHour <= 5) {
                        iconDiv.textContent = 'üåô';
                    } else {
                        iconDiv.textContent = getWeatherEmoji(data.hourly.weather_code[index]);
                    }
                    box.appendChild(iconDiv);

                    const tempDiv = document.createElement('div');
                    tempDiv.className = 'temp';
                    tempDiv.textContent = Math.round(data.hourly.temperature_2m[index]).toString() + "¬∞";
                    box.appendChild(tempDiv);

                    const windDiv = document.createElement('div');
                    windDiv.className = 'wind';
                    windDiv.textContent = Math.round(data.hourly.windspeed_10m[index]).toString() + "km/h";
                    box.appendChild(windDiv);

                    // Add shading if the current hour box for today is selected
                    if (selectedDate.toISOString().split('T')[0] === currentDate.toISOString().split('T')[0] && boxHour === currentHour) {
                        box.classList.add('current-hour');
                    }

                    weatherContainer.appendChild(box);
                }
            });
        } catch (error) {
            console.error('Error fetching hourly weather data:', error);
        }
    }



    
        async function fetchWeatherDataForLondon() {
            try {
                // Coordinates for London
                const londonLat = 51.5074;
                const londonLon = -0.1278;
    
                currentLatitude = londonLat;
                currentLongitude = londonLon;
    
                // Fetch and display weather data for today
                fetchWeatherDataHourly(londonLat, londonLon, getTodayDate());
    
                // Set up day boxes and select today
                updateDayBoxes();
                document.getElementById('day-1').classList.add('selected');
                document.querySelectorAll('.day-box').forEach(b => {
                    if (!b.classList.contains('selected')) {
                        b.classList.add('unselected');
                    }
                });
                document.getElementById('cityDisplay').textContent = 'London, United Kingdom';
            } catch (error) {
                console.error('Error fetching weather data for London:', error);
            }
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            // Update day boxes and show weather for today in London
            fetchWeatherDataForLondon();
        });
    
        const searchBar = document.getElementById('searchBar');
        searchBar.addEventListener('keydown', async function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
    
                const inputVal = searchBar.value;
                try {
                    const geocodeApiKey = '1c212ed6db9141f3a94761a660c42644';
                    const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${inputVal}&key=${geocodeApiKey}`);
                    const data = await response.json();
    
                    if (data.results.length > 0) {
                        const { lat, lng } = data.results[0].geometry;
                        currentLatitude = lat;
                        currentLongitude = lng;
    
                        document.getElementById('cityDisplay').textContent = data.results[0].formatted;
    
                        fetchWeatherDataWeek(lat, lng);
                        const firstDayBox = document.getElementById('day-1');
                        selectedDate = firstDayBox.getAttribute('data-date');
                        fetchWeatherDataHourly(lat, lng, selectedDate);
    
                        updateDayBoxes();
                        firstDayBox.classList.add('selected');
                        document.querySelectorAll('.day-box').forEach(b => {
                            if (!b.classList.contains('selected')) {
                                b.classList.add('unselected');
                            }
                        });
                    } else {
                        console.error('No results found for the location.');
                    }
                } catch (error) {
                    console.error('Error fetching coordinates:', error);
                }
            }
        });
    
        async function fetchWeatherDataWeek(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&start_date=${getTodayDate()}&end_date=${getEndDate(7)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.daily.time.map((date, index) => ({
                    date,
                    temperature_2m_max: data.daily.temperature_2m_max[index],
                    temperature_2m_min: data.daily.temperature_2m_min[index],
                    weather_code: data.daily.weather_code[index]
                }));
            } catch (error) {
                console.error('Error fetching weekly weather data:', error);
                throw error;
            }
        }

    
        function getEndDate(days) {
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + days);
            return endDate.toISOString().split('T')[0];
        }
    
        function getWeatherEmoji(code) {
            switch (code) {
                case 0:
                    return '‚òÄÔ∏è'; // Clear sky
                case 1:
                case 2:
                case 3:
                    return '‚õÖ'; // Mainly clear, partly cloudy, and overcast
                case 45:
                case 48:
                    return 'üå´Ô∏è'; // Fog and depositing rime fog
                case 51:
                case 53:
                case 55:
                    return 'üå¶Ô∏è'; // Drizzle: Light, moderate, and dense intensity
                case 56:
                case 57:
                    return 'üåßÔ∏è'; // Freezing Drizzle: Light and dense intensity
                case 61:
                case 63:
                case 65:
                    return 'üåßÔ∏è'; // Rain: Slight, moderate and heavy intensity
                case 66:
                case 67:
                    return 'üå®Ô∏è'; // Freezing Rain: Light and heavy intensity
                case 71:
                case 73:
                case 75:
                    return 'üå®Ô∏è'; // Snow fall: Slight, moderate, and heavy intensity
                case 77:
                    return 'üå®Ô∏è'; // Snow grains
                case 80:
                case 81:
                case 82:
                    return 'üå¶Ô∏è'; // Rain showers: Slight, moderate, and violent
                case 85:
                case 86:
                    return 'üå®Ô∏è'; // Snow showers slight and heavy
                case 95:
                    return '‚õàÔ∏è'; // Thunderstorm: Slight or moderate
                case 96:
                case 99:
                    return 'üå©Ô∏è'; // Thunderstorm with slight and heavy hail
                default:
                    return '‚ùì'; // Unknown weather code
            }
        }



        document.getElementById('locationButton').addEventListener('click', () => {
    // Check if Geolocation is supported
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Use the obtained latitude and longitude
            fetchWeatherDataWeek(lat, lon);
            fetchCityName(lat, lon);
            fetchWeatherDataHourly(lat, lon) // Call your function to fetch hourly data
                .then(data => {
                    const weatherContainer = document.getElementById('weatherContainer');
                    weatherContainer.innerHTML = ''; // Clear existing boxes

                    // Process and display hourly weather data
                    data.hourly.time.forEach((time, index) => {
                        const box = document.createElement('div');
                        box.className = 'box';

                        const timeDiv = document.createElement('div');
                        timeDiv.className = 'time';
                        timeDiv.textContent = new Date(time).getHours() + ':00';
                        box.appendChild(timeDiv);

                        const tempDiv = document.createElement('div');
                        tempDiv.className = 'temp';
                        tempDiv.textContent = `${Math.round(data.hourly.temperature_2m[index])}¬∞C`;
                        box.appendChild(tempDiv);

                        const precipDiv = document.createElement('div');
                        precipDiv.className = 'precipitation';
                        precipDiv.textContent = `${Math.round(data.hourly.precipitation[index])} mm`;
                        box.appendChild(precipDiv);

                        const windDiv = document.createElement('div');
                        windDiv.className = 'wind';
                        windDiv.textContent = `${Math.round(data.hourly.wind_speed_10m[index])} km/h`;
                        box.appendChild(windDiv);

                        weatherContainer.appendChild(box);
                    });
                })
                .catch(error => console.error('Error fetching hourly weather data:', error));
        }, (error) => {
            console.error('Error getting location:', error);
        });
    } else {
        console.error('Geolocation is not supported by this browser.');
    }
});

    </script>
</body>
</html>
