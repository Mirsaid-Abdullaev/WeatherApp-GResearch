<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Weather Update</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header-container">
        <div>WEATHER</div>
        <form action="/" method="get" class="search-form">
            <input type="text" class="location-input-box" id="searchBar" name="location" placeholder="Enter location...">
            <input type="submit" style="display: none;">
        </form>
    </div>

    <div class="city-name-container" id="cityNameContainer">City Name</div>
    
    <div class="day-selector">
        <div class="day-box" id="day-1">Today</div>
        <div class="day-box" id="day-2"></div>
        <div class="day-box" id="day-3"></div>
        <div class="day-box" id="day-4"></div>
        <div class="day-box" id="day-5"></div>
        <div class="day-box" id="day-6"></div>
        <div class="day-box" id="day-7"></div>
    </div>

    <div class="weather-container" id="weatherContainer">
        <!-- Boxes will be added here dynamically -->
    </div>

    <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
    </div>

    <script>
        let latitude, longitude;

        window.addEventListener('message', function (event) {
            if (event.data.latitude && event.data.longitude) {
                latitude = event.data.latitude;
                longitude = event.data.longitude;
                fetchWeatherDataWeek(latitude, longitude);
                fetchCityName(latitude, longitude);
                fetchWeatherDataHourly(latitude, longitude, getTodayDate());
            }
        });

        async function fetchWeatherDataHourly(lat, lon, selectedDate) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation,wind_speed_10m&timezone=auto`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                const filteredData = {
                    time: [],
                    temperature_2m: [],
                    precipitation: [],
                    wind_speed_10m: []
                };

                data.hourly.time.forEach((time, index) => {
                    if (new Date(time).toDateString() === new Date(selectedDate).toDateString()) {
                        filteredData.time.push(time);
                        filteredData.temperature_2m.push(data.hourly.temperature_2m[index]);
                        filteredData.precipitation.push(data.hourly.precipitation[index]);
                        filteredData.wind_speed_10m.push(data.hourly.wind_speed_10m[index]);
                    }
                });

                updateHourlyWeather(filteredData);
            } catch (error) {
                console.error('Error fetching hourly weather data:', error);
            }
        }

        async function fetchWeatherDataWeek(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max&timezone=auto&start_date=${getTodayDate()}&end_date=${getEndDate(7)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                const dates = [];
                const maxTemps = [];
                const minTemps = [];

                data.daily.time.forEach((date, index) => {
                    dates.push(formatDate(date, index === data.daily.time.length - 1));
                    maxTemps.push(Math.round(data.daily.temperature_2m_max[index]));
                    minTemps.push(Math.round(data.daily.temperature_2m_min[index]));
                });

                createTemperatureChart(dates, maxTemps, minTemps);
            } catch (error) {
                console.error('Error fetching weather data:', error);
            }
        }

        async function fetchCityName(lat, lon) {
            try {
                const response = await fetch(`/get_city_name?latitude=${lat}&longitude=${lon}`);
                const data = await response.json();
                document.getElementById('cityNameContainer').textContent = data.city || 'Error fetching city name';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        function getEndDate(days) {
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + days);
            return endDate.toISOString().split('T')[0];
        }

        function formatDate(dateString, isLastDay) {
            const date = new Date(dateString);
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                return "Today";
            } else {
                const options = { weekday: 'long' };
                const dayName = date.toLocaleDateString(undefined, options);
                return isLastDay ? `Next ${dayName}` : dayName;
            }
        }

        function getDayName(daysAfterToday) {
            const date = new Date();
            date.setDate(date.getDate() + daysAfterToday);
            const options = { weekday: 'long' };
            return date.toLocaleDateString(undefined, options).slice(0, 3);
        }

        function updateHourlyWeather(data) {
            const weatherContainer = document.getElementById('weatherContainer');
            weatherContainer.innerHTML = '';

            data.time.forEach((time, index) => {
                const box = document.createElement('div');
                box.className = 'box';

                const timeDiv = document.createElement('div');
                timeDiv.className = 'time';
                timeDiv.textContent = new Date(time).getHours() + ':00';
                box.appendChild(timeDiv);

                const tempDiv = document.createElement('div');
                tempDiv.className = 'temp';
                tempDiv.textContent = `${Math.round(data.temperature_2m[index])}째C`;
                box.appendChild(tempDiv);

                const precipDiv = document.createElement('div');
                precipDiv.className = 'precipitation';
                precipDiv.textContent = `${Math.round(data.precipitation[index])} mm`;
                box.appendChild(precipDiv);

                const windDiv = document.createElement('div');
                windDiv.className = 'wind';
                windDiv.textContent = `${Math.round(data.wind_speed_10m[index])} km/h`;
                box.appendChild(windDiv);

                weatherContainer.appendChild(box);
            });
        }

        var temperatureChart;
        function createTemperatureChart(dates, maxTemps, minTemps) {
            const ctx = document.getElementById('temperatureChart').getContext('2d');
            if (temperatureChart) {
                temperatureChart.destroy();
            }
            temperatureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Max Temperature (째C)',
                            data: maxTemps,
                            borderColor: 'red',
                            fill: false
                        },
                        {
                            label: 'Min Temperature (째C)',
                            data: minTemps,
                            borderColor: 'blue',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Temperature (째C)'
                            }
                        }
                    }
                }
            });
        }

        // Inside your existing event listener for day boxes
        document.querySelectorAll('.day-box').forEach((dayBox, index) => {
            dayBox.addEventListener('click', function () {
                document.querySelectorAll('.day-box').forEach(box => box.classList.remove('selected'));
                dayBox.classList.add('selected');

                const selectedDay = index;
                const selectedDate = new Date(new Date().setDate(new Date().getDate() + selectedDay)).toISOString().split('T')[0];
                fetchWeatherDataHourly(latitude, longitude, selectedDate); // Fetch data for the selected date
            });
        });


        document.getElementById('day-2').textContent = getDayName(1);
        document.getElementById('day-3').textContent = getDayName(2);
        document.getElementById('day-4').textContent = getDayName(3);
        document.getElementById('day-5').textContent = getDayName(4);
        document.getElementById('day-6').textContent = getDayName(5);
        document.getElementById('day-7').textContent = getDayName(6);

        document.getElementById('day-1').classList.add('selected');

        function updateWeatherDivs(data) {
            const tempDiv = document.querySelector('.temp');
            const precipDiv = document.querySelector('.precipitation');
            const windDiv = document.querySelector('.wind');

            // Assuming data contains temperature, precipitation, and wind speed
            tempDiv.textContent = `${Math.round(data.temperature_2m)}째C`;
            precipDiv.textContent = `${Math.round(data.precipitation)} mm`;
            windDiv.textContent = `${Math.round(data.wind_speed_10m)} km/h`;
        }


    </script>
</body>
</html>
